# UV Migration Guide

This document outlines the migration from pip to uv package manager for the RAG backend project.

## Why UV?

- **10-100x faster** than pip for dependency installation
- **Lock file support** for reproducible builds
- **Better dependency resolution**
- **Built-in virtual environment management**
- **Modern Python packaging standards**

## Migration Summary

### Files Changed

1. **pyproject.toml** (new)
   - Modern Python project configuration
   - Dependency specifications with version constraints
   - Development dependencies in separate section
   - Tool configurations (black, ruff, mypy, pytest)

2. **uv.lock** (new)
   - Lock file for reproducible builds
   - Exact versions of all dependencies
   - Generated by `uv sync --frozen`

3. **Dockerfile**
   - Added uv installation step
   - Uses `uv sync` instead of `pip install`
   - Smaller image sizes due to better caching

4. **requirements.txt** (updated)
   - Kept for backward compatibility
   - Now uses version ranges instead of exact versions
   - Comments guide users to use uv instead

5. **.gitignore** (new)
   - Added uv-specific cache directories
   - Proper Python ignore patterns

### Commands

#### Installation (with uv)
```bash
# Install uv
curl -LsSf https://astral.sh/uv/install.sh | sh

# Install dependencies
uv sync

# For development dependencies
uv sync --dev

# Run application
uv run uvicorn main:app --host 0.0.0.0 --port 7860
```

#### Legacy (with pip)
```bash
# Create virtual environment
python -m venv venv
source venv/bin/activate

# Install dependencies (slower)
pip install -r requirements.txt

# Run application
uvicorn main:app --host 0.0.0.0 --port 7860
```

## Benefits Achieved

### 1. Speed Improvements
- Initial dependency installation: 10-100x faster
- Subsequent installs: Near-instant with cache
- Better parallel downloading

### 2. Reproducibility
- Lock file ensures exact same versions across environments
- Deterministic builds
- Easy CI/CD integration

### 3. Better Developer Experience
- Single command for all setup: `uv sync --dev`
- Automatic virtual environment management
- Built-in dependency visualization

### 4. Modern Python Standards
- PEP 518/621 compliant
- Proper metadata in pyproject.toml
- Tool configurations in one place

## CI/CD Integration

### GitHub Actions Example
```yaml
- name: Set up uv
  run: curl -LsSf https://astral.sh/uv/install.sh | sh

- name: Install dependencies
  run: uv sync --frozen --no-install-project

- name: Run tests
  run: uv run pytest
```

### Docker Optimization
The updated Dockerfile uses uv's layer caching effectively:
- Installs uv once in base layer
- Copies pyproject.toml and uv.lock
- Runs `uv sync` (cached if dependencies unchanged)
- Faster builds due to better cache utilization

## Migration Checklist

- [x] Created pyproject.toml with all dependencies
- [x] Updated Dockerfile to use uv
- [x] Updated documentation (README.md, setup.md)
- [x] Added uv.lock for reproducible builds
- [x] Created scripts for lock file generation
- [x] Updated .gitignore for uv cache
- [x] Updated plan.md and tasks.md to reference uv

## For Developers

### First-time Setup
```bash
# Clone repository
git clone <repository-url>
cd ai-book/backend

# Install uv
curl -LsSf https://astral.sh/uv/install.sh | sh

# Install dependencies
uv sync --dev

# Start development server
uv run uvicorn main:app --reload
```

### Adding New Dependencies
```bash
# Add a new dependency
uv add fastapi>=0.109.0

# Add development dependency
uv add --dev pytest

# Remove dependency
uv remove requests

# Update all dependencies
uv sync --upgrade
```

### Common Commands
```bash
# Show dependency tree
uv tree

# Check for outdated packages
uv pip list --outdated

# Run commands in project context
uv run python --version
uv run python -c "import fastapi; print(fastapi.__version__)"

# Create virtual environment
uv venv

# Run with specific Python version
uv run --python 3.12 python script.py
```

## Troubleshooting

### Lock File Issues
```bash
# Regenerate lock file
rm uv.lock
uv sync --dev
```

### Cache Issues
```bash
# Clear uv cache
rm -rf .uv-cache/
uv sync --dev
```

### Version Conflicts
```bash
# Show dependency resolution
uv sync --verbose

# Force specific version
uv add "package==1.2.3"
```

## Next Steps

1. Update CI/CD pipelines to use uv
2. Add pre-commit hooks for uv lock validation
3. Set up automated dependency updates
4. Document team-wide uv setup instructions